<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fortuna AI</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #thread::-webkit-scrollbar{width:6px}#thread::-webkit-scrollbar-thumb{background:#94a3b8;border-radius:3px}
  </style>
</head>
<body class="bg-slate-50 min-h-screen flex flex-col sm:flex-row font-sans">

  <!-- ──────────────  SIDEBAR  ────────────── -->
  <aside class="w-full sm:w-72 bg-white border-r border-slate-200 p-4 flex flex-col gap-6">
    <h1 class="text-2xl font-bold text-indigo-600">Fortuna Centrique</h1>

    <!-- Receipts folder -->
    <section>
      <h2 class="font-semibold mb-2">Receipts</h2>
      <div id="receiptList" class="text-sm space-y-1 max-h-40 overflow-y-auto"></div>
      <label class="block mt-2 cursor-pointer text-indigo-600 hover:underline">
        + Add receipt
        <input type="file" accept="image/*" class="hidden" onchange="uploadFile(event,'receipt')" />
      </label>
    </section>

    <!-- Statements folder -->
    <section>
      <h2 class="font-semibold mb-2">Bank Statements</h2>
      <div id="statementList" class="text-sm space-y-1 max-h-40 overflow-y-auto"></div>
      <label class="block mt-2 cursor-pointer text-indigo-600 hover:underline">
        + Add statement
        <input type="file" accept=".pdf,.csv" class="hidden" onchange="uploadFile(event,'statement')" />
      </label>
    </section>

    <div class="mt-auto text-xs text-slate-500">© 2025 Fortuna AI</div>
  </aside>

  <!-- ──────────────  CHAT  ────────────── -->
  <main class="flex-1 flex flex-col">
    <div id="thread" class="flex-1 overflow-y-auto p-4 space-y-3"></div>

    <!-- typing indicator -->
    <div class="flex items-center px-4 py-1 text-sm text-slate-500">
      <span id="typing" class="hidden">Fortuna is typing<span class="animate-pulse">…</span></span>
    </div>

    <!-- message box -->
    <div class="border-t bg-white p-4">
      <textarea id="message" rows="2" placeholder="Ask Fortuna…" class="w-full border rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea>
      <button onclick="sendChat()" class="mt-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg float-right">Send</button>
    </div>
  </main>

<!-- ──────────────  SCRIPT  ────────────── -->
<script>
// ---- global state ----
const system = { role:'system', content:'You are Fortuna, a concise upbeat financial coach.' };
let history = JSON.parse(localStorage.getItem('fortunaHistory')||'[]');
const thread = document.getElementById('thread');

renderThread();

// ---- helpers ----
function addBubble(role,text){
  const div=document.createElement('div');
  div.className=`bubble ${role==='user'?'bg-indigo-600 text-white ml-auto':'bg-slate-200 text-slate-900 mr-auto'} max-w-[80%] px-4 py-2 rounded-2xl whitespace-pre-wrap`;
  div.textContent=text; thread.appendChild(div); thread.scrollTop=thread.scrollHeight;
}
function renderThread(){ thread.innerHTML=''; history.forEach(m=>addBubble(m.role,m.content)); }

// ---- token clipping ----
const MAX_TOKENS=3000;
function lastTokens(arr){
  let tot=0, slice=[];
  for(let i=arr.length-1;i>=0;i--){const est=arr[i].content.length/4; if(tot+est>MAX_TOKENS)break; slice.unshift(arr[i]); tot+=est;}
  return slice;
}

// ---- CHAT ----
async function sendChat(){
  const msg=document.getElementById('message').value.trim();
  if(!msg) return; document.getElementById('message').value='';
  history.push({role:'user',content:msg}); addBubble('user',msg);
  localStorage.setItem('fortunaHistory',JSON.stringify(history));

  document.getElementById('typing').hidden=false;
  try{
    const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages:lastTokens([system,...history])})});
    const j=await res.json(); if(!res.ok) throw new Error(j.error||'chat failed');

    const reply=j.choices?.[0]?.message?.content?.trim()||'[no reply]';
    history.push({role:'assistant',content:reply});
    localStorage.setItem('fortunaHistory',JSON.stringify(history));
    addBubble('assistant',reply);
  }catch(e){ console.error(e); addBubble('assistant','⚠️ '+e.message); }
  finally{ document.getElementById('typing').hidden=true; thread.scrollTop=thread.scrollHeight; }
}

// ---- FILE UPLOADS ----
async function uploadFile(ev,type){
  const file=ev.target.files[0]; if(!file) return;
  const allowedImg=['image/png','image/jpeg','image/jpg','image/webp','image/gif'];
  if(type==='receipt' && !allowedImg.includes(file.type)) return addBubble('assistant','⚠️ Unsupported image type');
  const fd=new FormData(); fd.append('file',file);
  const route= type==='receipt'? '/api/itemise': '/api/statement';
  const listEl=document.getElementById(type==='receipt'?'receiptList':'statementList');
  const row=document.createElement('div'); row.textContent=file.name+' – uploading…'; listEl.appendChild(row);

  try{
    const res=await fetch(route,{method:'POST',body:fd});
    const j=await res.json(); if(!res.ok) throw new Error(j.error||'upload failed');
    row.textContent=file.name+' ✅'; row.classList.add('text-green-700');
    addBubble('assistant', JSON.stringify((j.items||j.summary),null,2));
  }catch(e){ row.textContent=file.name+' ❌'; row.classList.add('text-red-600'); addBubble('assistant','⚠️ '+e.message); }
}
</script>
</body>
</html>
